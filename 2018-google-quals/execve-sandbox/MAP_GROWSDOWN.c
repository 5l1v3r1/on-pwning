#include <stdio.h>
#include <string.h>
#include <sys/mman.h>

int main()
{
    void *target_addr = (void *)0x10030000;
    printf("target_addr: %p\n", target_addr);

    void *mmap_addr = target_addr + 0x1000;
    printf("mmap_addr:   %p\n", mmap_addr);

    size_t mmap_length = 0x1000;
    printf("mmap_length: 0x%08x\n", mmap_length);

    mmap(mmap_addr, mmap_length, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS | MAP_GROWSDOWN, 0, 0);

    // See __do_page_fault() in linux/arch/x86/mm/fault.c
    void *rsp = target_addr;
    if (target_addr + 65536 + 32 * sizeof(unsigned long) < rsp)
    {
        printf("NOPE! INCOMING SEGFAULT\n");
    }
    printf("rsp:         %p\n", rsp);
    asm("mov %0, %%rsp"
        :
        : "r"(rsp));

    strcpy((char *)target_addr, "Hello, World!");
    printf("[%p] %s\n", target_addr, (char *)target_addr);
    return 0;
}
